<div class="app-container">
  <!-- Hero Section -->
  <section class="hero">
    <div class="hero-content">
      <h1>Welcome {{ store.userFirstName$ | async }}!</h1>
      <p>Scan receipts, track expenses, discover deals</p>
      <button class="hero-button" (click)="openCamera()">Scan a Receipt</button>
    </div>
  </section>

  <!-- Main Content -->
  <div class="dashboard">
    <!-- User Info & Stats -->
    <div class="user-info">
      <h2>Monthly Expenses: ${{ (store.monthlyExpenses$ | async) | number:'1.2-2' }}</h2>
      <p>Track your spending with our <strong>Expense Tracker</strong></p>
    </div>

    <!-- Rewards Promo -->
    <div class="rewards-promo" routerLink="/rewards">
      <div class="rewards-icon">üéÅ</div>
      <div class="rewards-text">
        <h3>Earn Rewards!</h3>
        <p>Get points every time you scan a receipt</p>
      </div>
      <a class="view-rewards-btn" routerLink="/rewards">View</a>
    </div>
  </div>

  <!-- Scanner Section -->
  <div class="dashboard-card" *ngIf="!(store.imagePreview$ | async)">
    <h3>Receipt Scanner</h3>
    <div class="scanner-options">
      <div class="scanner-option" (click)="triggerFileInput()">
        <div class="option-icon">üñºÔ∏è</div>
        <p>Upload Receipt</p>
      </div>
      <div class="scanner-option" (click)="openCamera()">
        <div class="option-icon">üì∏</div>
        <p>Take Photo</p>
      </div>
    </div>
  </div>
  
  <!-- Receipt Preview & Processing -->
  <div class="dashboard-card" *ngIf="store.imagePreview$ | async">
    <h3>Receipt Scanner</h3>
    
    <!-- Receipt Image Preview -->
    <div class="image-preview">
      <img [src]="store.imagePreview$ | async" alt="Receipt Preview">
    </div>
    
    <!-- Processing State -->
    <div class="processing-state" *ngIf="store.isProcessing$ | async">
      <div class="spinner"></div>
      <p>{{ store.processingMessage$ | async }}</p>
    </div>
    
    <!-- Error Message -->
    <div class="error-message" *ngIf="store.error$ | async">
      <p>{{ store.error$ | async }}</p>
      <button class="action-btn" (click)="store.resetScanner()">Try Again</button>
    </div>
    
    <!-- Extracted Data -->
    <div class="extracted-data" *ngIf="(store.extractedData$ | async) && !(store.isProcessing$ | async) && !(store.error$ | async)">
      <h4>Extracted Data</h4>
      
      <div class="data-grid">
        <div class="data-row">
          <span class="data-label">Merchant:</span>
          <span class="data-value">{{ (store.extractedData$ | async)?.merchantName }}</span>
        </div>
        
        <div class="data-row">
          <span class="data-label">Amount:</span>
          <span class="data-value">${{ store.formatCurrency((store.extractedData$ | async)?.totalAmount || 0) }}</span>
        </div>
        
        <div class="data-row">
          <span class="data-label">Date:</span>
          <span class="data-value">{{ store.formatDate((store.extractedData$ | async)?.dateOfPurchase) }}</span>
        </div>
        
        <div class="data-row">
          <span class="data-label">Category:</span>
          <span class="data-value">{{ (store.extractedData$ | async)?.category || 'Auto-detected' }}</span>
        </div>
      </div>
      
      <!-- OCR Full Text Toggle -->
      <div class="ocr-toggle" (click)="toggleFullText()">
        {{ (store.showFullText$ | async) ? 'Hide OCR Text' : 'Show OCR Text' }}
      </div>
      
      <!-- OCR Text (Collapsed by Default) -->
      <div class="ocr-text" *ngIf="store.showFullText$ | async">
        <pre>{{ store.ocrText$ | async }}</pre>
      </div>
      
      <!-- Action Buttons -->
      <div class="scanner-actions">
        <button class="action-btn primary" (click)="saveReceipt()">Save Receipt</button>
        <button class="action-btn secondary" (click)="store.resetScanner()">Cancel</button>
      </div>
    </div>
    
    <!-- Scan Controls (when no data extracted yet) -->
    <div class="scanner-actions" *ngIf="!(store.extractedData$ | async) && !(store.isProcessing$ | async) && !(store.error$ | async)">
      <button class="action-btn primary" (click)="uploadImage()">Analyze Receipt</button>
      <button class="action-btn secondary" (click)="store.resetScanner()">Cancel</button>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="(store.isLoading$ | async) && !(store.imagePreview$ | async)">
    <div class="spinner"></div>
    <p>Loading your data...</p>
  </div>

  <!-- Empty State - No Data -->
  <div class="empty-state" *ngIf="!(store.hasData$ | async) && !(store.isLoading$ | async) && !(store.imagePreview$ | async)">
    <div class="empty-icon">üìä</div>
    <h4>No Data Yet</h4>
    <p>Start by scanning receipts to track expenses and discover deals!</p>
    <button class="action-btn primary" (click)="openCamera()">Scan Your First Receipt</button>
  </div>

  <!-- Saved Promotions Section -->
  <!-- Fixed the nullable operator check for length -->
  <div class="promotions-section" *ngIf="(store.savedPromotions$ | async)?.length && (store.savedPromotions$ | async)!.length > 0">
    <div class="section-header">
      <h3>Your Saved Promotions</h3>
      <a routerLink="/saved-promotions" class="view-all">
        View All <span class="arrow-icon">‚Üí</span>
      </a>
    </div>
    
    <div class="saved-promotions-scroll">
      <div class="promo-card" *ngFor="let promo of (store.displayedSavedPromotions$ | async)" (click)="viewPromotionDetails(promo)">
        <div class="promo-image">
          <img [src]="promo.imageUrl || 'placeholder-image.jpg'" [alt]="promo.merchant">
          
          <!-- Expiry Badge -->
          <div class="expiry-badge" *ngIf="promo.expiry && store.isExpiringSoon(promo.expiry) && !store.hasExpired(promo.expiry)">
            Expiring Soon
          </div>
          <div class="expiry-badge expired" *ngIf="promo.expiry && store.hasExpired(promo.expiry)">
            Expired
          </div>
        </div>
        
        <div class="promo-content">
          <div class="promo-merchant">{{ promo.merchant }}</div>
          <div class="promo-description">{{ promo.description | slice:0:60 }}{{ promo.description && promo.description.length > 60 ? '...' : '' }}</div>
          <div class="promo-expiry" *ngIf="promo.expiry">Expires: {{ store.formatDate(promo.expiry) }}</div>
        </div>
        
        <div class="promo-actions">
          <button class="view-btn">View Details</button>
          <button class="remove-btn" (click)="removeSavedPromotion(promo.id); $event.stopPropagation()">Remove</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Recommended Promotions Section -->
  <div class="promotions-section" *ngIf="(store.recommendedPromotions$ | async)?.length && (store.recommendedPromotions$ | async)!.length > 0">
    <div class="section-header">
      <h3>Recommended For You</h3>
      <a routerLink="/promotions" class="view-all">
        View All <span class="arrow-icon">‚Üí</span>
      </a>
    </div>
    
    <!-- Recommended Categories -->
    <div *ngFor="let category of (store.recommendedPromotions$ | async)" class="category-section">
      <div class="category-header">
        <h4>{{ category.name }}</h4>
      </div>
      
      <div class="promo-scroll-container">
        <div class="promo-card" *ngFor="let promo of category.deals.slice(0, 5)" (click)="viewPromotionDetails(promo)">
          <div class="promo-image">
            <img [src]="promo.imageUrl || 'placeholder-image.jpg'" [alt]="promo.merchant">
          </div>
          
          <div class="promo-content">
            <div class="promo-merchant">{{ promo.merchant }}</div>
            <div class="promo-description">{{ promo.description | slice:0:60 }}{{ promo.description && promo.description.length > 60 ? '...' : '' }}</div>
            <div class="promo-expiry" *ngIf="promo.expiry">Expires: {{ store.formatDate(promo.expiry) }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Success Notification -->
  <div class="success-notification" *ngIf="store.showSuccessNotification$ | async">
    <div class="success-content">
      <div class="success-icon">‚úì</div>
      <div class="success-message">
        <h4>Success!</h4>
        <p>{{ store.successNotificationMessage$ | async }}</p>
      </div>
      <button class="close-notification" (click)="closeSuccessNotification()">√ó</button>
    </div>
    <div class="timer-bar">
      <div class="timer-progress" [style.width.%]="store.notificationTimeRemaining$ | async"></div>
    </div>
  </div>

  <!-- Promotion Details Modal -->
  <div class="promotion-details-modal" *ngIf="store.selectedPromotion$ | async">
    <div class="modal-overlay" (click)="closePromotionDetails()"></div>
    <div class="modal-content">
      <button class="close-button" (click)="closePromotionDetails()">√ó</button>
      
      <div class="promo-detail-image">
        <img [src]="(store.selectedPromotion$ | async)?.imageUrl || 'placeholder-image.jpg'" [alt]="(store.selectedPromotion$ | async)?.merchant">
      </div>
      
      <div class="promo-detail-info">
        <h4>{{ (store.selectedPromotion$ | async)?.description }}</h4>
        
        <div class="promo-detail-row">
          <span class="label">Merchant:</span>
          <span>{{ (store.selectedPromotion$ | async)?.merchant }}</span>
        </div>
        
        <div class="promo-detail-row" *ngIf="(store.selectedPromotion$ | async)?.code">
          <span class="label">Promo Code:</span>
          <div class="promo-code">{{ (store.selectedPromotion$ | async)?.code }}</div>
        </div>
        
        <div class="promo-detail-row" *ngIf="(store.selectedPromotion$ | async)?.expiry">
          <span class="label">Valid Until:</span>
          <span [class.expired-text]="store.hasExpired((store.selectedPromotion$ | async)?.expiry)">
            {{ store.formatDate((store.selectedPromotion$ | async)?.expiry) }}
            <span class="expiry-status" *ngIf="(store.selectedPromotion$ | async)?.expiry && store.hasExpired((store.selectedPromotion$ | async)?.expiry)">(Expired)</span>
            <span class="expiry-status expiring" *ngIf="(store.selectedPromotion$ | async)?.expiry && store.isExpiringSoon((store.selectedPromotion$ | async)?.expiry) && !store.hasExpired((store.selectedPromotion$ | async)?.expiry)">(Expiring Soon)</span>
          </span>
        </div>
        
        <div class="promo-detail-row" *ngIf="(store.selectedPromotion$ | async)?.location">
          <span class="label">Location:</span>
          <span>{{ (store.selectedPromotion$ | async)?.location }}</span>
        </div>
        
        <div class="promo-detail-row" *ngIf="(store.selectedPromotion$ | async)?.conditions">
          <span class="label">Terms:</span>
          <div class="conditions">{{ (store.selectedPromotion$ | async)?.conditions }}</div>
        </div>
      </div>
      
      <div class="promo-detail-actions">
        <!-- Use saveSelectedPromotion() method -->
        <button class="action-button" (click)="saveSelectedPromotion()">
          Save Promotion
        </button>
      </div>
    </div>
  </div>

  <!-- Hidden file input for camera functionality -->
  <input 
    type="file" 
    accept="image/*" 
    (change)="onFileSelected($event)" 
    style="display: none;" 
  >
</div>